<!DOCTYPE html><html class="appearance-auto" lang="en"><head><meta charset="UTF-8"><title>Pytorch-Hookæœºåˆ¶</title><meta name="description" content="The harder you work, the luckier you will be~"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="Hookæ˜¯ä»€ä¹ˆï¼ŸHook(é’©å­)å…¶å®å¹¶ä¸æ˜¯Pytorchç‰¹æœ‰çš„æœºåˆ¶ï¼Œå…¶åœ¨è½¯ä»¶å·¥ç¨‹ä¸­ä¹Ÿæ˜¯ç›¸å½“å¸¸è§çš„ï¼Œä¸€èˆ¬æ¥è¯´Hookè¡¨ç¤ºä¸€ç§è‡ªåŠ¨è§¦å‘çš„æœºåˆ¶ï¼Œå³åœ¨é‡åˆ°æŸäº›æ—¶é—´/æƒ…å†µä¹‹åä¼šè‡ªåŠ¨æ‰§è¡Œçš„äº‹é¡¹ï¼Œå…¶å®åœ¨ç”Ÿæ´»ä¸­ä¹Ÿä¼šé‡åˆ°å¾ˆå¤šHookçš„äº‹ä»¶ï¼š

ç§»åŠ¨åˆ°å…‰çº¿å˜åŒ–çš„ç¯å¢ƒé‡Œï¼Œæ‰‹æœºå±å¹•äº®åº¦ä¼šè·Ÿç€å˜åŒ–
æ°´çƒ§å¼€åå°±ä¼šæ²¸è…¾æŠŠå£¶ç›–é¡¶å¼€
ç«ç¾æƒ…å†µä¸‹æ¸©åº¦å‡é«˜è‡ªåŠ¨è§¦å‘æŠ¥è­¦ç³»ç»Ÿå’Œç­ç«å–·å¤´

æ€»è€Œè¨€ä¹‹ï¼Œè™½ç„¶ä¸Šé¢å¾ˆå¤šæƒ…å†µå³ä¾¿æ²¡æœ‰Hookï¼Œæˆ‘ä»¬ä¹Ÿèƒ½å®ç°(æ¯”å¦‚æ‰‹åŠ¨è°ƒäº®åº¦ã€æ‰‹åŠ¨æ‰“å¼€æŠ¥è­¦å’Œç­ç«å™¨ç­‰)ï¼Œä½†æ˜¯Hookä½œä¸ºä¸€ç§å¼ºå¤§çš„è‡ªåŠ¨è§¦å‘æœºåˆ¶ï¼Œèƒ½å¤Ÿå¾ˆå¤§ç¨‹åº¦ä¸Šå¸®åŠ©æˆ‘ä»¬æé«˜æ•ˆç‡ã€‚
Pytorchä¸­çš„ Hookæ˜¯å¹²å˜›çš„ï¼Ÿå½“æƒ³è¦æŸ¥çœ‹ç½‘ç»œè¾“å‡ºä¸­æ¯å±‚ç‰¹å¾çš„shapeæ—¶ï¼Œæœ‰æ²¡æœ‰è¿‡æ‰‹åŠ¨printæ¯ä¸ªtensor.shapeçš„æƒ…å†µï¼Ÿè™½ç„¶å¿«ä½†æ˜¯ä¸â€œä¼˜é›…â€è€Œä¸”å¾ˆæœ‰å¯èƒ½å¯¼è‡´ä»£ç æ˜¾å¾—å†—ä½™æ‚ä¹±.."><meta name="generator" content="Hexo 6.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style><link rel="alternate" href="/atom.xml" title="Georgeqi_Blog" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Georgeqi's Blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Pytorch-Hookæœºåˆ¶</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Hook%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-text">Hookæ˜¯ä»€ä¹ˆï¼Ÿ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pytorch%E4%B8%AD%E7%9A%84-Hook%E6%98%AF%E5%B9%B2%E5%98%9B%E7%9A%84%EF%BC%9F"><span class="toc-text">Pytorchä¸­çš„ Hookæ˜¯å¹²å˜›çš„ï¼Ÿ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pytorch%E4%B8%ADHook%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-text">Pytorchä¸­Hookçš„åº”ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%89%93%E5%8D%B0%E4%B8%AD%E9%97%B4%E5%BC%A0%E9%87%8F%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="toc-text">1.æ‰“å°ä¸­é—´å¼ é‡çš„ä¿¡æ¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%8F%90%E5%8F%96%E7%89%B9%E5%BE%81"><span class="toc-text">2.æå–ç‰¹å¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%A2%AF%E5%BA%A6%E8%A3%81%E5%89%AA1"><span class="toc-text">3.æ¢¯åº¦è£å‰ª1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%A2%AF%E5%BA%A6%E8%A3%81%E5%89%AA2"><span class="toc-text">3.æ¢¯åº¦è£å‰ª2</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">æ€»ç»“</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80"><i class="tag post-item-tag">ç¼–ç¨‹è¯­è¨€</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">Pytorch-Hookæœºåˆ¶</h1><time class="has-text-grey" datetime="2023-08-10T08:01:50.000Z">2023-08-10</time><article class="mt-2 post-content"><h1 id="Hookæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#Hookæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="Hookæ˜¯ä»€ä¹ˆï¼Ÿ"></a>Hookæ˜¯ä»€ä¹ˆï¼Ÿ</h1><p>Hook(é’©å­)å…¶å®å¹¶ä¸æ˜¯Pytorchç‰¹æœ‰çš„æœºåˆ¶ï¼Œå…¶åœ¨è½¯ä»¶å·¥ç¨‹ä¸­ä¹Ÿæ˜¯ç›¸å½“å¸¸è§çš„ï¼Œä¸€èˆ¬æ¥è¯´Hookè¡¨ç¤ºä¸€ç§è‡ªåŠ¨è§¦å‘çš„æœºåˆ¶ï¼Œå³åœ¨é‡åˆ°æŸäº›æ—¶é—´/æƒ…å†µä¹‹åä¼šè‡ªåŠ¨æ‰§è¡Œçš„äº‹é¡¹ï¼Œå…¶å®åœ¨ç”Ÿæ´»ä¸­ä¹Ÿä¼šé‡åˆ°å¾ˆå¤šHookçš„äº‹ä»¶ï¼š</p>
<ul>
<li>ç§»åŠ¨åˆ°å…‰çº¿å˜åŒ–çš„ç¯å¢ƒé‡Œï¼Œæ‰‹æœºå±å¹•äº®åº¦ä¼šè·Ÿç€å˜åŒ–</li>
<li>æ°´çƒ§å¼€åå°±ä¼šæ²¸è…¾æŠŠå£¶ç›–é¡¶å¼€</li>
<li>ç«ç¾æƒ…å†µä¸‹æ¸©åº¦å‡é«˜è‡ªåŠ¨è§¦å‘æŠ¥è­¦ç³»ç»Ÿå’Œç­ç«å–·å¤´</li>
</ul>
<p>æ€»è€Œè¨€ä¹‹ï¼Œè™½ç„¶ä¸Šé¢å¾ˆå¤šæƒ…å†µå³ä¾¿æ²¡æœ‰Hookï¼Œæˆ‘ä»¬ä¹Ÿèƒ½å®ç°(æ¯”å¦‚æ‰‹åŠ¨è°ƒäº®åº¦ã€æ‰‹åŠ¨æ‰“å¼€æŠ¥è­¦å’Œç­ç«å™¨ç­‰)ï¼Œä½†æ˜¯Hookä½œä¸ºä¸€ç§å¼ºå¤§çš„è‡ªåŠ¨è§¦å‘æœºåˆ¶ï¼Œèƒ½å¤Ÿå¾ˆå¤§ç¨‹åº¦ä¸Šå¸®åŠ©æˆ‘ä»¬æé«˜æ•ˆç‡ã€‚</p>
<h1 id="Pytorchä¸­çš„-Hookæ˜¯å¹²å˜›çš„ï¼Ÿ"><a href="#Pytorchä¸­çš„-Hookæ˜¯å¹²å˜›çš„ï¼Ÿ" class="headerlink" title="Pytorchä¸­çš„ Hookæ˜¯å¹²å˜›çš„ï¼Ÿ"></a><strong>Pytorchä¸­çš„ Hookæ˜¯å¹²å˜›çš„ï¼Ÿ</strong></h1><p>å½“æƒ³è¦æŸ¥çœ‹ç½‘ç»œè¾“å‡ºä¸­æ¯å±‚ç‰¹å¾çš„shapeæ—¶ï¼Œæœ‰æ²¡æœ‰è¿‡æ‰‹åŠ¨printæ¯ä¸ª<code>tensor.shape</code>çš„æƒ…å†µï¼Ÿè™½ç„¶å¿«ä½†æ˜¯ä¸â€œä¼˜é›…â€è€Œä¸”å¾ˆæœ‰å¯èƒ½å¯¼è‡´ä»£ç æ˜¾å¾—å†—ä½™æ‚ä¹±ã€‚è¿™æ—¶å€™å¦‚æœåœ¨ç½‘ç»œå‰å‘è¿‡ç¨‹ä¸­è®¾ç½®hookæœºåˆ¶ï¼Œå°±èƒ½è‡ªåŠ¨æ‰“å°å¼ é‡çš„shapeï¼Œå¹¶ä¸”ä¸ä¼šå½±å“åŸä»£ç çš„åŠŸèƒ½å’Œé€»è¾‘ï¼Œè¿™äº›è¢«æ·»åŠ çš„å°åŠŸèƒ½å°±åƒä¸€ä¸ªå°é’©å­ğŸªä¸€æ ·â€œæŒ‚â€åœ¨åŸä»£ç é€»è¾‘ä¸Šä½†æ˜¯ä¸ä¼šæ”¹å˜åŸé€»è¾‘ã€‚</p>
<p>åœ¨Pytorchä¸­Hookèƒ½åšçš„äº‹æƒ…éå¸¸å¤šï¼š</p>
<ul>
<li>æ‰“å°è¾“å‡ºæ¯å±‚å¼ é‡çš„shape</li>
<li>æŸ¥çœ‹æˆ–ä¿®æ”¹æ¯å±‚å‚æ•°çš„æ¢¯åº¦(æ¯”å¦‚è¿›è¡Œæ¢¯åº¦è£å‰ª)</li>
<li>å¯è§†åŒ–ç½‘ç»œä¸­é—´å±‚çš„ç‰¹å¾å›¾</li>
<li>â€¦.</li>
</ul>
<p>åœ¨Pytorchä¸­å¸¸ç”¨çš„å¯ä»¥ç»™å¼ é‡(Tensor)æˆ–è€…æ¨¡å‹(Module)è®¾ç½®Hook:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/generated/torch.Tensor.register_hook.html?highlight=hook">torch.Tensor.register_hook</a></li>
<li><a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/generated/torch.nn.Module.html?highlight=hook#torch.nn.Module.register_forward_hook">torch.nn.Module.register_forward_hook</a>ï¼šåœ¨å‰å‘æ¨ç†æ—¶æ‰§è¡Œ</li>
<li><a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/generated/torch.nn.Module.html?highlight=hook#torch.nn.Module.register_backward_hook">torch.nn.Module.register_backward_hook</a></li>
</ul>
<p>é’ˆå¯¹Tensorå’ŒModuleçš„hookå‡½æ•°ç­¾åå¦‚ä¸‹:</p>
<pre><code class="python">from torch import nn, Tensor
def module_hook(module:nn.Module, input:Tensor, output:Tensor):
    # æ¥å—moduleç±»å‹å¯¹è±¡ï¼ŒåŠå…¶è¾“å…¥è¾“å‡ºï¼Œè¿™é‡Œå¯ä»¥åšå°ºå¯¸çš„æ‰“å°ã€æ¢¯åº¦è£å‰ªã€ç‰¹å¾æå–ç­‰
    
def tensor_hook(grad:Tensor):
      # æ¥å—tensorçš„æ¢¯åº¦ä¿¡æ¯ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥åšå°ºå¯¸çš„æ‰“å°ã€æ¢¯åº¦è£å‰ª
</code></pre>
<h1 id="Pytorchä¸­Hookçš„åº”ç”¨"><a href="#Pytorchä¸­Hookçš„åº”ç”¨" class="headerlink" title="Pytorchä¸­Hookçš„åº”ç”¨"></a>Pytorchä¸­Hookçš„åº”ç”¨</h1><h2 id="1-æ‰“å°ä¸­é—´å¼ é‡çš„ä¿¡æ¯"><a href="#1-æ‰“å°ä¸­é—´å¼ é‡çš„ä¿¡æ¯" class="headerlink" title="1.æ‰“å°ä¸­é—´å¼ é‡çš„ä¿¡æ¯"></a>1.æ‰“å°ä¸­é—´å¼ é‡çš„ä¿¡æ¯</h2><pre><code class="python">import torch
from torch import nn, Tensor

class DemoMoudule(nn.Module):
    def __init__(self):
        super().__init__()
        # æ„å»ºä¸€ä¸ªç®€å•çš„DNNç½‘ç»œ: ç”±ä¸¤ä¸ªå·ç§¯è¾“å…¥å±‚ã€ä¸€ä¸ªBNå±‚ã€ä¸€ä¸ªå·ç§¯è¾“å‡ºå±‚
        self.conv_in = nn.Sequential(nn.Conv2d(3, 2, 3, 2),
                                      nn.Conv2d(2, 1, 3, 2))
        self.bn = nn.BatchNorm2d(1)
        self.conv_out = nn.Conv2d(1, 20, 3, 1)

        # ä¸ºè¯¥ç½‘ç»œçš„æ¯ä¸ªä¸€çº§å­module(å³conv_inã€bnå’Œconv_out)æ³¨å†Œå‰å‘hook,
        # åœ¨forwardæ—¶å€™ä¼šè‡ªåŠ¨è°ƒç”¨å¯¹åº”çš„å‡½æ•°(è¿™é‡Œæ˜¯æ‰“å°è¯¥moduleè¾“å‡ºå±‚çš„åç§°ã€å°ºå¯¸ã€å‡å€¼)
        for name, layer in self.named_children():
            layer.__name__ = name
            layer.register_forward_hook(
                lambda l, _, output:
                print("{}:{},{}".format(l.__name__, output.shape, torch.mean(output)))
            )
            
    def forward(self, x: Tensor) -&gt; Tensor:
        x = self.conv_in(x)
        x = self.bn(x)
        x = self.conv_out(x)
        return x

demo_model = DemoMoudule()
dummy_input = torch.ones(10, 3, 28, 28)
dummy_output = demo_model(dummy_input)
'''
è¾“å‡ºï¼š
conv_in:torch.Size([10, 1, 6, 6]),-0.3441038727760315
bn:torch.Size([10, 1, 6, 6]),0.0
conv_out:torch.Size([10, 20, 4, 4]),0.07038399577140808
'''
</code></pre>
<p>åˆ©ç”¨æ­¤æŠ€æœ¯ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é’ˆå¯¹å·²æœ‰çš„ç½‘ç»œï¼ˆæ¯”å¦‚ResNet50ï¼‰,åœ¨ä¸ä¿®æ”¹è¯¥ç½‘ç»œå®šä¹‰å’Œæºç çš„åŒæ—¶ä½¿ç”¨ç±»ä¼¼ä¸Šé¢çš„ä¸€ä¸ªå°è£…ï¼Œåœ¨å‰å‘è¿‡ç¨‹ä¸­æ‰“å°å¯¹åº”çš„å¼ é‡å°ºå¯¸(å¯å‚è€ƒ<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/279903361">zhihu.McGL</a>)ã€‚</p>
<h2 id="2-æå–ç‰¹å¾"><a href="#2-æå–ç‰¹å¾" class="headerlink" title="2.æå–ç‰¹å¾"></a>2.æå–ç‰¹å¾</h2><pre><code class="python">import torch
from torch import nn, Tensor
from typing import Iterable, Dict

class FeatureExtreactor(nn.Module):
    def __init__(self, model: nn.Module, layer_names:Iterable[str]):
        super().__init__()
        self.model = model
        self.layer_names = layer_names
        self.__extraced_features = {}

        org_modules = dict([*self.model.named_modules()])
        for layer_name in layer_names:
            layer = org_modules[layer_name]
            layer.__name__ = layer_name
            # å°†æŒ‡å®šåç§°çš„Moduleè¾“å‡ºæ·»åŠ åˆ°å¾…è¿”å›çš„é›†åˆä¸­
            layer.register_forward_hook(self.append_features)

    def append_features(self, layer, _, output_tensor):
        self.__extraced_features[layer.__name__] = output_tensor

    def forward(self, x: Tensor) -&gt; Dict[str, Tensor]:
        _ = self.model(x)
        return self.__extraced_features

# è·å–æŒ‡å®šå±‚çš„å±æ€§
feature_extreactor = FeatureExtreactor(demo_model, layer_names=["conv_in", "conv_out"])
dummy_input = torch.ones(10, 3, 28, 28)
demo_features = feature_extreactor(dummy_input)
for name, feature in demo_features.items():
    print("{}: {} {}".format(name, feature.shape, torch.mean(feature)))
    
'''
åœ¨ä½¿ç”¨ä¹‹å‰DemoMoudule()ç±»çš„æƒ…å†µä¸‹ï¼Œè¾“å‡ºï¼š
conv_in: torch.Size([10, 1, 6, 6]) 0.05633455887436867
conv_out: torch.Size([10, 20, 4, 4]) 0.04933914169669151
'''
</code></pre>
<p>ä¸Šé¢åˆ©ç”¨Moduleçš„å‰å‘hookå¯ä»¥æ ¹æ®æŒ‡å®šçš„æ¨¡å—åè·å–ç½‘ç»œæŒ‡å®šçš„ç‰¹å¾å±‚ï¼Œæœ‰äº†è·å–çš„ç‰¹å¾å±‚ï¼Œæˆ‘ä»¬èƒ½åšçš„äº‹æƒ…å°±éå¸¸å¤šäº†ï¼Œä¸ä»…ä»…è·å–shapeã€å‡å€¼ï¼Œæ­¤å¤–ä¹Ÿèƒ½è¿›è¡Œç‰¹å¾å›¾å¯è§†åŒ–ç­‰ç­‰ã€‚</p>
<p>è€Œåœ¨æ·±åº¦å­¦ä¹ ä¸­å¸¸å¸¸ä¼šè¦æ±‚è®¡ç®—å›¾åƒçš„VGGç‰¹å¾ä¹Ÿå¯ä»¥ä½¿ç”¨è¯¥æ–¹æ³•æ¨ç†è·å¾—ã€‚</p>
<h2 id="3-æ¢¯åº¦è£å‰ª1"><a href="#3-æ¢¯åº¦è£å‰ª1" class="headerlink" title="3.æ¢¯åº¦è£å‰ª1"></a>3.æ¢¯åº¦è£å‰ª1</h2><p>åœ¨æœªè¿›è¡Œæ¢¯åº¦è£å‰ªçš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‰“å°demo_modelç½‘ç»œæœ€åä¸€ä¸ªå·ç§¯çš„å‰10ä¸ªbiaseçš„æ¢¯åº¦å¦‚ä¸‹:</p>
<pre><code class="python">demo_model = DemoMoudule()
dummy_input = torch.ones(10, 3, 28, 28)
pred = demo_model(dummy_input)
loss = pred.log().mean()
loss.backward()
print(demo_model.conv_out.bias.grad)
'''
è¾“å‡ºï¼š
tensor([  0.7894,   1.0285,  -0.6203,  -0.1882,   0.6290,  -0.2002,   0.5751,
          0.1875,  -0.5093,   0.3338,  -1.4956,   0.2797,  -0.4018,  -0.1860,
        -12.1006,   0.2474,   1.7059,   0.1834,   0.3505,   0.3189])
'''
</code></pre>
<p>åœ¨ä½¿ç”¨Tensorå½¢å¼çš„hookæœºåˆ¶æ—¶ï¼Œæˆ‘ä»¬è®¾å®šå‚æ•°çš„æ¢¯åº¦tensorçš„æ¢¯åº¦åœ¨æŸä¸ªèŒƒå›´å†…ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code class="python">def gradient_clipper(model: nn.Module, clip_val:float)-&gt; nn.Module:
    for parameter in model.parameters():
        # å¯¹æ¢¯åº¦tensoræ·»åŠ ç”¨äºæ¢¯åº¦æˆªæ–­çš„hook
        parameter.register_hook(lambda grad: grad.clamp_(-clip_val, clip_val))
    return model

clipped_model = gradient_clipper(demo_model, 0.01)
pred = clipped_model(dummy_input)
loss = pred.log().mean()
loss.backward()
print(clipped_model.conv_out.bias.grad)

'''
è¾“å‡ºï¼š
tensor([-0.0100, -0.0100,  0.0100, -0.0100, -0.0100, -0.0100,  0.0100, -0.0100,
        -0.0100, -0.0100,  0.0100, -0.0100, -0.0100,  0.0100,  0.0100,  0.0100,
        -0.0100,  0.0100, -0.0100, -0.0100])
å¯ä»¥çœ‹åˆ°æ¢¯åº¦è¢«é™åˆ¶åˆ°-0.01~0.01ä¹‹é—´ã€‚
'''
</code></pre>
<h2 id="3-æ¢¯åº¦è£å‰ª2"><a href="#3-æ¢¯åº¦è£å‰ª2" class="headerlink" title="3.æ¢¯åº¦è£å‰ª2"></a>3.æ¢¯åº¦è£å‰ª2</h2><p>ä½¿ç”¨Moduelçš„register_backward_hookå‡½æ•°ä¹Ÿèƒ½è¿›è¡Œæ¢¯åº¦è£å‰ªï¼š</p>
<pre><code class="python">def gradient_clipper2(model: nn.Module, clip_val:float)-&gt; nn.Module:
    # grad_inputå…ƒç»„åŒ…å«(biasçš„æ¢¯åº¦ï¼Œè¾“å…¥xçš„æ¢¯åº¦ï¼Œæƒé‡weightçš„æ¢¯åº¦)ï¼Œgrad_outputå…ƒç»„åŒ…å«è¾“å‡ºyçš„æ¢¯åº¦ã€‚
    # è¿”å›çš„æ˜¯ä¿®æ”¹åçš„grad_input
    def back_hook(module, grad_input, grad_output):
        print('grad_input: ', grad_input)
        print('grad_output: ', grad_output)
        return grad_input[0].clamp(-clip_val, clip_val), \
               grad_input[1].clamp(-clip_val*2, clip_val*2), \
               grad_input[2].clamp(-clip_val*3, clip_val*3),
    for moduel in model.modules():
        moduel.register_backward_hook(back_hook)
    return model

# å› ä¸ºgrad_inputæ˜¯å¯¹è¾“å…¥xçš„æ¢¯åº¦ï¼Œæ‰€ä»¥è¦æ±‚xä¹Ÿæ˜¯æœ‰æ¢¯åº¦çš„ï¼Œå³è¦è®¾å®šrequires_grad=True
x = torch.tensor([[1., 2., 10.]], requires_grad=True)
module = gradient_clipper2(nn.Linear(3, 2), 0.001)
y = module(x)
y.mean().backward()
print('module_bias: {}, x:{} module_weight:{}'.
      format(module.bias.grad, x.grad, module.weight.grad))

'''
è¾“å‡º:
grad_input:  (tensor([0.5000, 0.5000]), tensor([[0.2492, 0.2174, 0.0614]]),  tensor([[0.5000, 0.5000],
        [1.0000, 1.0000],
        [5.0000, 5.0000]]))
grad_output:  (tensor([[0.5000, 0.5000]]),)
module_bias: tensor([0.0010, 0.0010]), x:tensor([[0.0020, 0.0020, 0.0020]]) module_weight:tensor([[0.0030, 0.0030, 0.0030], [0.0030, 0.0030, 0.0030]])
'''
</code></pre>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>hookæœºåˆ¶èƒ½å¤Ÿæ–¹ä¾¿å¿«æ·åœ°å¸®åŠ©æˆ‘ä»¬åšä¸€äº›è°ƒè¯•ç­‰è¾…åŠ©å·¥ä½œï¼ŒåŒæ—¶ä¹Ÿèƒ½ä¿è¯ä»£ç çš„ç®€æ´æ€§ï¼Œå…¶å®é™¤äº†ä¸Šé¢çš„ä¸‰ç§hookï¼Œpytorchè¿˜æœ‰register_full_backward_hookã€register_forward_pre_hookç­‰ï¼Œä½†æ˜¯æ¯”è¾ƒå¸¸ç”¨çš„ä¸‰ç§å’Œå¯¹åº”çš„ç”¨æ³•åˆ—åœ¨ä¸Šé¢äº†ï¼Œå…¶ä»–çš„ç”¨åˆ°æ—¶å€™å†è‡ªå·±çœ‹åè¡¥å……è¿›æ¥ï¼</p>
<p>å‚è€ƒ:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/generated/torch.nn.Module.html?highlight=hook">https://pytorch.org/docs/stable/generated/torch.nn.Module.html?highlight=hook</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/sddai/p/14412250.html">https://www.cnblogs.com/sddai/p/14412250.html</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/279903361">https://zhuanlan.zhihu.com/p/279903361</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/winycg/article/details/100695373">https://blog.csdn.net/winycg/article/details/100695373</a></li>
</ul>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2023/10/10/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0-%E6%96%B0%E8%A7%86%E8%A7%92%E7%94%9F%E6%88%90(NVS)/" title="è®ºæ–‡ç¬”è®°-æ–°è§†è§’ç”Ÿæˆ(NVS)"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: è®ºæ–‡ç¬”è®°-æ–°è§†è§’ç”Ÿæˆ(NVS)</span></a><a class="button is-default" href="/2023/06/10/Diffusion%E5%AD%A6%E4%B9%A06-%E7%94%9F%E6%88%90%E5%8F%AF%E6%8E%A7%E6%80%A7/" title="Diffusionå­¦ä¹ 6-ç”Ÿæˆå¯æ§æ€§"><span class="has-text-weight-semibold">Next: Diffusionå­¦ä¹ 6-ç”Ÿæˆå¯æ§æ€§</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="qzq2514/qzq2514.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com/qzq2514"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/qzq2514"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com/qzq2514"><i class="iconfont icon-ins"></i></a><!-- publish--><a title="publish" target="_blank" rel="noopener nofollow" href="https://blog.csdn.net/qzq2514"><i class="iconfont icon-rss"></i></a><!-- RSS--><!-- çŸ¥ä¹--><a title="zhihu" target="_blank" rel="noopener nofollow" href="//zhihu.com/people/qi-zhong-qi-62"><i class="iconfont icon-zhihu"></i></a><!-- é¢†è‹±--><!-- è„¸ä¹¦--></section><p><span>Copyright Â©</span><span> Georgeqi 2024</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>